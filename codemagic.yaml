workflows:
  ios_testflight:
    name: ThreadLoop iOS (Capacitor → TestFlight)
    max_build_duration: 60
    instance_type: mac_mini_m2

    integrations:
      app_store_connect: "ThreadLoop API Key"

    environment:
      xcode: latest
      node: 18
      cocoapods: default
      vars:
        BUNDLE_ID: "com.threadloop.app"
        TEAM_ID: "ANYNJ42USZ"
        SCHEME: "App"
        WORKSPACE: "ios/App/App.xcworkspace"
        PROJECT_PATH: "ios/App"
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.threadloop.app

    scripts:
      - name: Install Node deps
        script: npm ci || npm i

      - name: Build web assets
        script: npm run build

      - name: Add/sync iOS (Capacitor)
        script: |
          npx cap add ios || true
          npx cap sync ios

      - name: Install CocoaPods
        working_directory: ios/App
        script: pod install --repo-update

      - name: Ensure bundle id & team in Xcode project
        working_directory: ios/App
        script: |
          set -e
          sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = [^;]*;/PRODUCT_BUNDLE_IDENTIFIER = $BUNDLE_ID;/g" App.xcodeproj/project.pbxproj
          sed -i '' "s/DEVELOPMENT_TEAM = [A-Z0-9]*/DEVELOPMENT_TEAM = $TEAM_ID/g" App.xcodeproj/project.pbxproj

      - name: Apply profiles
        script: xcode-project use-profiles

      - name: Build IPA
        script: |
          set -e
          # Build + export IPA
          xcode-project build-ipa --workspace "$WORKSPACE" --scheme "$SCHEME"

          # The exporter should place the IPA here:
          IPA_PATH="build/ios/ipa/App.ipa"
          if [ ! -f "$IPA_PATH" ]; then
            echo "❌ Expected IPA not found at $IPA_PATH. Searching..."
            find . -name "*.ipa" -maxdepth 4 -print
            exit 2
          fi

          echo "✅ Found IPA at $IPA_PATH"
          # Try to copy to Codemagic's artifacts dir if it's valid
          if [ -n "$CM_ARTIFACTS" ] && [ "$CM_ARTIFACTS" != "/" ]; then
            mkdir -p "$CM_ARTIFACTS"
            cp -v "$IPA_PATH" "$CM_ARTIFACTS/"
          fi

          # Always leave a local fallback for artifact collection
          mkdir -p build/artifacts
          cp -v "$IPA_PATH" build/artifacts/
          echo "Artifacts listing:"
          ls -lah "$CM_ARTIFACTS" 2>/dev/null || true
          ls -lah build/artifacts || true

    artifacts:
      - build/ios/ipa/App.ipa
      - build/artifacts/*.ipa
      - $CM_ARTIFACTS/*.ipa
      - /Users/builder/export_options.plist

    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
